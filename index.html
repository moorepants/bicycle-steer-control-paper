<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Jason K. Moore" />
  <meta name="dcterms.date" content="2023-05-20" />
  <title>Summative Robotic Bicycle Steer Control or Effect of Automatic Bicycle Balance Stabilization to Rider Control and Handling</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for citations */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
    }
    .hanging-indent div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Summative Robotic Bicycle Steer Control or Effect of
Automatic Bicycle Balance Stabilization to Rider Control and
Handling</h1>
<p class="author">Jason K. Moore</p>
<p class="date">2023-05-20</p>
</header>
<h1 id="introduction">Introduction</h1>
<p>Automatic roll stabilization of single track vehicles began in
earnest after predictive motorcycle models were developed and refined
throughout the 1970s. Van Zytveld <span class="citation"
data-cites="Zytveld1975">(van Zytveld 1975)</span> seems to be the first
to attempt to robotically stabilize a small motorbike with a controlled
inverted pendulum that mimicked rider lean, but was not successful in
demonstrating what his control model predicted. It was not until the mid
1980s in which someone successfully demonstrated an automatically
balanced motorcycle <span class="citation"
data-cites="Ruijs1986a">(Ruijs and Pacejka 1986)</span>. Ruijs and
Pacejka showed that steer torque driven by roll angle feedback
stabilizes the capsize mode, roll rate feedback stabilizes the weave
mode of a motorcycle, and steer angular rate feedback stabilizes the
wobble mode. They also show how the gains need to change with respect to
vehicle speed. This is the simplest controller that can stabilize a
single track vehicle above a minimum speed. Many more automatically
balanced single track vehicles have been demonstrated over the last 40
years, but none of these advancements have resulted in a successful
commercial product. Most of these robotic bicycles and motorcycles
designers did not intend for a human rider to also control the
stabilized vehicle. Although, an automatically stabilized bicycle can be
controlled by a human rider if the motor controlled steer torque and the
rider applied steer torque act on the steer in sum. Given that premise,
I want to answer this question:</p>
<p>Given a bicycle that has a motor (with power, torque, speed,
bandwidth limits) which can apply a torque between the rear and front
frames and a set of sensors that can give good measurements or estimates
of the bicycle’s steer angle, steering rate, roll angle, and rolling
rate what closed loop dynamics and motion are possible and how might a
rider controlling this stabilized bicycle find the behavior?</p>
<p>Some other notes:</p>
<ul>
<li><p>we only care about the lateral dynamics and handling qualities
of</p></li>
<li><p>we will only explore mathematical and computational
models</p></li>
</ul>
<h1 id="model">Model</h1>
<p>The linear Whipple-Carvallo bicycle model <span class="citation"
data-cites="Whipple1899a Carvallo1899 Meijaard2007">(<strong>Whipple1899a?</strong>;
Carvallo 1899; Meijaard et al. 2007)</span> is the simplest bicycle
model that exhibits non-minimum phase behavior and self-stablity. It can
be described by the state space equations:</p>
<p><span class="math display">\[\begin{aligned}
  \dot{\bar{x}} = \mathbf{A} \bar{x} + \mathbf{B} \bar{u}
  \textrm{ where }
  \bar{x} = \begin{bmatrix} \phi \\ \dot{\phi} \\ \delta \\ \dot{\delta}
\end{bmatrix}
  \textrm{ and }
  \bar{u} = \begin{bmatrix} T_{\phi} \\ T_{\delta} \end{bmatrix}
\end{aligned}\]</span></p>
<p>The states are the roll angle <span
class="math inline">\(\phi\)</span> and steer angle <span
class="math inline">\(\delta\)</span> along with their derivatives and
the inputs are roll torque <span class="math inline">\(T_\phi\)</span>
and steer torque <span class="math inline">\(T_\delta\)</span>. The
state <span class="math inline">\(\mathbf{A}\)</span> and input <span
class="math inline">\(\mathbf{B}\)</span> matrices are populated with
expressions that are functions of 27 geometric and inertial parameters
of the nonholonomic mulitbody system made up of four rigid bodies: two
wheels, front frame, and rear frame.</p>
<p>I use realistic numeric values for the state and input matrices
measured from a Batatuvs Browser Dutch-style city bicycle and a XX kg
rider whos inertira properties were estimated using the method of
Yeadon. These calculations were performed with the BicycleParameters and
yeadon software <span class="citation" data-cites="Dembia2015">(Dembia,
Moore, and Hubbard 2015)</span>. The following table gives the numerical
values of the vehicle.</p>
<p>TODO: Add table of parameters.</p>
<figure id="fig:uncontrolled-with-rider-geometry">
<img src="figures/uncontrolled-with-rider-geometry.png" />
<figcaption>Geometry, mass, and inertia of the bicycle-rider
system.</figcaption>
</figure>
<h1 id="controllability">Controllability</h1>
<p>The Whipple-Carvallo model can be uncontrollable at specific speeds.
<span class="citation" data-cites="Schwab2010a">(Schwab and Kooijman
2010)</span> showed uncontrollable speeds for two extended
Whipple-Carvallo models (with rider lean) and their degree of
uncontrollability using modal controllability. It is also true that the
non-extended Whipple-Carvallo model exhibits uncontrollable speeds when
controlling with steer torque, but notably <span
class="math inline">\(v=0\)</span> is not one of those speeds.</p>
<p>The controllability matrix <span
class="math inline">\(\mathbf{C}\)</span> can be formed for the steer
input, <span class="math inline">\(T_\delta\)</span>. There are speed
parameter values where the linear Whipple-Carvallo bicycle model is
uncontrollable. Solving the <span
class="math inline">\(det(\mathbf{C}(v))=0\)</span> returns two speeds
in the range <span class="math inline">\([0, 10]\)</span> m/s that are
uncontrollable.</p>
<figure id="fig:uncontrolled-eigenvalues-with-rider">
<img src="figures/uncontrolled-eigenvalues-with-rider.png" />
<figcaption>Real and imaginary parts of the eigenvalues as a function of
speed. Vertical black lines indicate uncontrollable
dynamics.</figcaption>
</figure>
<p>I have no idea why this model is uncontrollable at these specific
speeds.</p>
<p>We can also look at the modal controllability to see the degree of
controllability Fig. <a href="#fig:modal-controllability"
data-reference-type="ref"
data-reference="fig:modal-controllability">3</a>.</p>
<figure id="fig:modal-controllability">
<img src="figures/modal-controllability.png" />
<figcaption>Testing</figcaption>
</figure>
<p>I don’t think this model controllability calc is correct because it
isn’t smooth and it doesn’t reveal the two uncontrollable speeds.</p>
<h1 id="stabilization-with-roll-and-steer-feedback">Stabilization with
Roll and Steer Feedback</h1>
<p>One IMU on the handlebars and one on the rear frame easily gives:
roll rate and steer rate. Steer angle sensor gives steer angle. Roll
angle must be estimated.</p>
<p>Single motor that applies a torque between the rear frame and the
handlebars/fork.</p>
<p>Assume that the torque between the two frames is the sum of the motor
and the rider:</p>
<p><span class="math display">\[\begin{aligned}
  T_\delta = T_{\delta,\textrm{human}} + T_{\delta,\textrm{motor}}
\end{aligned}\]</span></p>
<p>The motor is driven by a full state feedback controller:</p>
<p><span class="math display">\[\begin{aligned}
  T_{\delta,\textrm{motor}} =
  k_\phi \phi +
  k_\delta \delta +
  k_{\dot{\phi}} \dot{\phi} +
  k_{\dot{\delta}} \dot{\delta}
\end{aligned}\]</span></p>
<p>The motor closed loop dynamics is then:</p>
<p><span class="math display">\[\begin{aligned}
  \dot{\bar{x}} = \left( \mathbf{A} - \mathbf{B} \mathbf{K} \right)
\bar{x} +
  \mathbf{B} \left[ T_\phi \quad T_{\delta,\textrm{human}} \right]^T \\
\end{aligned}\]</span></p>
<p>where</p>
<p><span class="math display">\[\begin{aligned}
  \mathbf{K} =
  \begin{bmatrix}
    0 &amp; 0 &amp; 0 &amp; 0 \\
    k_\phi &amp; k_\delta &amp; k_{\dot{\phi}} &amp; k_{\dot{\delta}}
  \end{bmatrix}
\end{aligned}\]</span></p>
<p>Note that the rider still applies steer torque through the original B
matrix and any roll disturbances also through same B matrix. The human
controlled dynamics can be manipulated by changing the motor controller
gains.</p>
<h1 id="proportional-dervivative-roll-control">Proportional Dervivative
Roll Control</h1>
<p>Proportional Derivative Roll Control</p>
<ul>
<li><p>What are the achievable closed loop dynamics?</p></li>
<li><p>Vary speed and controller gain, show 3D root locus</p></li>
<li><p>Pick a speed and vary the controller gain, show 2D root
locus</p></li>
<li><p>Difference with and without a rigid rider</p></li>
<li><p>Could be PD on roll rate criteria (overshoot, decay time) and
then pole placement with the two parameters for each speed to get
similar behavior across speeds.</p></li>
<li><p>What if we only have rate feedback (raw IMU data)? Does steer
rate feedback help?</p></li>
</ul>
<p>It is well known that at low speeds simple proportional positive
feedback of roll rate stabilize the bicycle. This is positive roll
derivative feedback.</p>
<figure id="fig:roll-rate-eig-effect">
<img src="figures/roll-rate-eig-effect.png" />
<figcaption>Effect on the motor controlled closed loop dynamics with
changing <span class="math inline">\(k_{\dot{\phi}}\)</span>. Blue to
yellow varies the gain from zero to a large value.</figcaption>
</figure>
<p>Roll rate feedback alone is not sufficient to stabilize the bicycle
at very low speeds (&lt; 0.5 m/s), even with infinite gains, and speeds
where the capsize mode is unstable. But if roll angle and roll rate are
available to feedback, the bicycle can also be stabilized at the higher
speeds. If you gain schedule roll angle and roll rate feedback to both
stabilize sufficiently while minimizing the weave frequency exponential
functions provide a good model for gain scheduling with respect to
speed.</p>
<figure id="fig:pd-gains-vs-speed">
<img src="figures/pd-gains-vs-speed.png" />
<figcaption>Exponentially scheduled roll angle and roll rate gains with
respect to speed.</figcaption>
</figure>
<p>The roll PD gain scheduling with respect to speed stabilizes at all
speeds above about 0.75 m/s and retains similar dynamics except that the
weave frequency is significantly higher <a href="#fig:pd-eigenvalues"
data-reference-type="ref" data-reference="fig:pd-eigenvalues">6</a>.</p>
<figure id="fig:pd-eigenvalues">
<img src="figures/pd-eigenvalues.png" />
<figcaption>Root locus of the eigenvalues components with respect to
speed when the gain scheduling in Figure <a
href="#fig:pd-gains-vs-speed" data-reference-type="ref"
data-reference="fig:pd-gains-vs-speed">5</a> are applied. Grey lines are
the uncontrolled bicycle.</figcaption>
</figure>
<p>At very low speeds large steer torques and steer angles are required
to stabilize the system.</p>
<figure id="fig:pd_simulation">
<img src="figures/pd-simulation.png" />
<figcaption>Simulation with saturated steer torque.</figcaption>
</figure>
<h1 id="full-state-feedback">Full State Feedback</h1>
<p>If you now assume full state feedback and we drive the state to zero
as before, an LQR controller can be realized at each speed. Assumed
<span class="math inline">\(\mathbf{Q}\)</span> and <span
class="math inline">\(\mathbf{R}\)</span> to be identity for simplicity.
I also scale the gains proportionally to limit the maximum torque that
can be applied for some expected maximum motion. If you dot that, you
get some LQR gain scheduling over speed. The required gains at the
uncontrollable points go to infinity, so you basically can’t stabilize
below the largest uncontrollable speed.</p>
<figure id="fig:lqr-gains">
<img src="figures/lqr-gains.png" />
<figcaption>Gain scheduled LQR gains.</figcaption>
</figure>
<p>Using the scheduling in Figure <a href="#fig:lqr-gains"
data-reference-type="ref" data-reference="fig:lqr-gains">8</a> give the
dynamics in Figure <a href="#fig:lqr-eig" data-reference-type="ref"
data-reference="fig:lqr-eig">9</a>. The LQR solution manages to
stabilize the system without drastically changing the dynamics, in
particular the weave frequency is unchanged. If large gains are
permitted, the LQR controller theoretically can stabilize the bicycle at
v=0 speed.</p>
<figure id="fig:lqr-eig">
<img src="figures/lqr-eig.png" />
<figcaption>Root locus of eigenvalue components with the LQR gain
scheduling.</figcaption>
</figure>
<p>Here is a low speed simulation with LQR solution.</p>
<figure id="fig:lqr-simulation">
<img src="figures/lqr-simulation.png" />
<figcaption>Testing</figcaption>
</figure>
<p>What do the transfer functions from human steer to roll look like
when they are controlling the closed loop motor controlled bike? For a
very low speed, there is a damped resonant peak around 3 rad/s which
changes the way the vehicle feels in the human control bandwidth.</p>
<figure id="fig:lqr-steer-roll-bode-compare-v01">
<img src="figures/lqr-steer-roll-bode-compare-v01.png" />
<figcaption>Orange is with the motor control on, blue is
without.</figcaption>
</figure>
<figure id="fig:lqr-steer-roll-bode-compare-v05">
<img src="figures/lqr-steer-roll-bode-compare-v05.png" />
<figcaption>Orange is with the motor control on, blue is
without.</figcaption>
</figure>
<figure id="fig:lqr-steer-roll-bode-compare-v10">
<img src="figures/lqr-steer-roll-bode-compare-v10.png" />
<figcaption>Orange is with the motor control on, blue is
without.</figcaption>
</figure>
<p>Would it be better/possible to ask for the gains that make the Bode
plot of controlled bike match the uncontrolled bike at high speeds? This
would give matching feeling to the rider.</p>
<h1 id="motor-limitations">Motor limitations</h1>
<p>Set bounds on steer torque, power, and even bandwidth then solve for
the open loop steer torque needed to stabilize at various speeds.</p>
<p>Set bounds on steer torque, power, and even bandwidth then solve for
the open loop steer torque and solve for the four gains that stabilize
the system with under maximal performance bounds.</p>
<p>Is it of value to add a motor dynamics equation into the mix? A full
state feedback would then require measuring motor current.</p>
<h1 id="can-we-mimic-other-real-bicycles">Can we mimic other real
bicycles?</h1>
<p>Optimization that finds controller parameters for matching
dynamics?</p>
<h1 id="comparison-of-the-gyrobike-and-the-steer-motor">Comparison of
the gyrobike and the steer motor</h1>
<p>Show how the same dynamics can be produced</p>
<p>Energy costs comparison</p>
<h1 id="add-human-control">Add human control</h1>
<p>What human steer torques are required for normal maneuvers? Is it
higher for the stabilized bikes?</p>
<p>Is the stability detrimental to maneuverability?</p>
<p>Handling quality metric for the gain scheduled controllers.</p>
<div id="refs" class="references csl-bib-body hanging-indent"
role="list">
<div id="ref-Carvallo1899" class="csl-entry" role="listitem">
Carvallo, E. 1899. <em>Théorie Du Mouvement Du Monocycle Et de La
Bicyclette</em>. <span>Paris, France</span>: <span>Gauthier-
Villars</span>.
</div>
<div id="ref-Dembia2015" class="csl-entry" role="listitem">
Dembia, Chris, Jason K. Moore, and Mont Hubbard. 2015. <span>“An Object
Oriented Implementation of the <span>Yeadon</span> Human Inertia
Model.”</span> <em>F1000Research</em> 3 (233). <a
href="https://doi.org/10.12688/f1000research.5292.2">https://doi.org/10.12688/f1000research.5292.2</a>.
</div>
<div id="ref-Meijaard2007" class="csl-entry" role="listitem">
Meijaard, J. P., Jim M. Papadopoulos, Andy Ruina, and A. L. Schwab.
2007. <span>“Linearized Dynamics Equations for the Balance and Steer of
a Bicycle: <span>A</span> Benchmark and Review.”</span> <em>Proceedings
of the Royal Society A: Mathematical, Physical and Engineering
Sciences</em> 463 (2084): 1955–82. <a
href="https://doi.org/10.1098/rspa.2007.1857">https://doi.org/10.1098/rspa.2007.1857</a>.
</div>
<div id="ref-Ruijs1986a" class="csl-entry" role="listitem">
Ruijs, P. A. J., and H. B. Pacejka. 1986. <span>“Recent
<span>Research</span> in <span>Lateral Dynamics</span> of
<span>Motorcycles</span>.”</span> <em>Vehicle System Dynamics</em> 15
(sup1): 467–80. <a
href="https://doi.org/10.1080/00423118608969155">https://doi.org/10.1080/00423118608969155</a>.
</div>
<div id="ref-Schwab2010a" class="csl-entry" role="listitem">
Schwab, A. L., and J. D. G. Kooijman. 2010. <span>“Controllability of a
Bicycle.”</span> In <em>5th Asian Conference on Multibody Dynamics
2010</em>. <span>Kyoto, Japan</span>.
</div>
<div id="ref-Zytveld1975" class="csl-entry" role="listitem">
van Zytveld, P. 1975. <span>“A Method for the Automatic Stabilization of
an Unmanned Bicycle.”</span> PhD thesis, Stanford University.
</div>
</div>
</body>
</html>
